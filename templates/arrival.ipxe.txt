#!ipxe

set boot-host:string {{ url_root }}
set tftp-origin:string ${filename}

set bios-vendor:string ${smbios/0.4.0}
set bios-version:string ${smbios/0.5.0}
set bios-revision:string ${smbios/0.8.0}
set si-vendor:string ${smbios/1.4.0}
set si-product_name:string ${smbios/1.5.0}
set si-version:string ${smbios/1.6.0}
set si-serial:string ${smbios/1.7.0}
set si-uuid:string ${smbios/1.8.16}
set board-vendor:string ${smbios/2.4.0}
set board-product_name:string ${smbios/2.5.0}
set board-serial:string ${smbios/2.7.0}
set board-asset:string ${smbios/2.8.0}
set cpu-name:string ${smbios/4.16.0}

set cpu0type:string ${smbios/0.4.6.1:hex}: ${smbios/0.4.16.0}
set cpu1type:string ${smbios/1.4.6.1:hex}: ${smbios/1.4.16.0}
set cpu2type:string ${smbios/2.4.6.1:hex}: ${smbios/2.4.16.0}
set cpu3type:string ${smbios/3.4.6.1:hex}: ${smbios/3.4.16.0}


echo |------------------------------------------------------------------------------|
echo |----------------| iPXE Network Boot Menu Generator v0.9 |---------------------|
echo |------------------------------------------------------------------------------|
echo DHCP: Boot source was ${filename}
echo HOST: Generated by ${boot-host}
echo THIS: You have arrived at "arrival.ipxe"
echo CHASSIS: ${si-vendor} ${si-product_name} ${si-serial} ${si-version}
echo BOARD: ${board-vendor} ${board-product_name} ${board-serial} ${board-asset}
echo BIOS: ${bios-vendor} ${bios-version} ${bios-revision}
echo CPU: ${cpu-name}
echo |------------------------------------------------------------------------------|
echo |-------------------------| Enumerating CPUS... |------------------------------|
echo |------------------------------------------------------------------------------|
echo CPU0: Type ${cpu0type}
echo CPU1: Type ${cpu1type}
echo CPU2: Type ${cpu2type}
echo CPU3: Type ${cpu3type}
echo |------------------------------------------------------------------------------|

# Build up the URL parameters to send
set inv:string mac=${net0/mac}
set inv ${inv}&ip=${net0/ip}
set inv ${inv}&uuid=${uuid}
set inv ${inv}&board=${board-vendor:uristring}${board-product_name:uristring}
set inv ${inv}&si-vendor=${si-vendor:uristring}
set inv ${inv}&si-product=${si-product_name:uristring}
set inv ${inv}&si-serial=${si-serial:uristring}
set inv ${inv}&si-version=${si-version:uristring}
set inv ${inv}&board-vendor=${board-vendor:uristring}
set inv ${inv}&board-product=${board-product_name:uristring}
set inv ${inv}&board-serial=${board-serial:uristring}
set inv ${inv}&board-asset=${board-asset:uristring}
set inv ${inv}&bios-vendor=${bios-vendor:uristring}
set inv ${inv}&bios-version=${bios-version:uristring}
set inv ${inv}&bios-revision=${bios-revision:uristring}
set inv ${inv}&cpu0=${cpu0type:uristring}
set inv ${inv}&end=yes

chain ${boot-host}inventory.ipxe?${inv}
exit 0
